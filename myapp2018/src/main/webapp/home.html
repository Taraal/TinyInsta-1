<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
<head>
    <meta http-equiv="content-type" content="application/xhtml+xml; charset=UTF-8" />
    <title>TinyInsta</title>
    <style>
	.post-img { width: 300px; }
	h1 { color: rgb(34, 147, 245); margin: 15px; }
	body { font-family: "Verdana", "Times New Roman", Times, serif; }
	hr { width:100%; height:1px; background: #fff; margin-bottom: 8px; }
	form { margin-bottom: 10px; }
	</style>
</head>

<body>




<script src="https://unpkg.com/mithril/mithril.js"></script>





<script>

function setFormActionUrl(vnode) {
    fetch("http://localhost:8080/blobstore-upload-url")
        .then((response) => {
            return response.text();
        })
        .then((imageUploadUrl) => {
            const messageForm = document.getElementById("createPostForm");
            messageForm.action = imageUploadUrl;

        });
}

function fetchSession() {
    fetch("http://localhost:8080/session")
        .then(response => response.text())
        .then(data => {
            Session.current.name = data
            Session.listPost()
        })
}

var SearchForm = {
    values: {},
}

var Session = {
    current: {},
    userPost: [],
    listPost: function() {
        return m.request({
                method: "GET",
                url: "http://localhost:8080/_ah/api/myApi/v1/getSubscriberPost/:userName",
                params: {
                    userName: Session.current.name
                },
            })
            .then(function(result) {
                if (result != null) {
                    Session.userPost = result.items
                } else {
                    Session.userPost = null
                }

            })
    }
}


function createUserPage(userName) {


    m.request({

        method: "GET",
        url: "http://localhost:8080/_ah/api/myApi/v1/getUserLight/:userName",
        params: {
            userName: userName
        },

    })
    .then(function(resultUser) {

        console.log(resultUser)

        if(resultUser != null) {


            m.request({
                method: "GET",
                url: "http://localhost:8080/_ah/api/myApi/v1/getUserPost/:userName",
                params: {
                    userName: userName
                },
            })
            .then(function(resultPosts) {


            console.log(resultPosts)


            m.request({
                method: "GET",
                url: "http://localhost:8080/_ah/api/myApi/v1/isSubscribed/:userA/:userB",
                params: {
                    userA: Session.current.name,
                    userB: userName
                },
            })
            .then(function(resultSubscribed) {

                console.log(resultSubscribed)

                var followText = "";
                var alreadyFollowed = false;


                if (resultSubscribed != null) {

                    followText = "Unfollow"
                    alreadyFollowed = true

                } else {

                    followText = "Follow"
                    alreadyFollowed = false
                }

                m.mount(document.body, null) // Clean the body
                m.render(document.body, m("div", {
                    class: "user-div"
                },
                [
                    m("div", m(MenuLogo)),


                    m("h2", "About " + userName),



                    m(
                        "button", {
                            id: "follow_btn",
                            class: "follow_btn",
                            onclick: function() {


                                if (alreadyFollowed == false) {

                                    m.request({
                                        method: "GET",
                                        url: "http://localhost:8080/_ah/api/myApi/v1/followUser/:follower/:followee",
                                        params: {
                                            follower: Session.current.name,
                                            followee: userName
                                        },
                                    })
                                    .then(function(result) {
                                        alreadyFollowed = true
                                        var x = document.getElementById("follow_btn").innerHTML = "Unfollow"
                                    })


                                } else {

                                    m.request({
                                        method: "GET",
                                        url: "http://localhost:8080/_ah/api/myApi/v1/unfollowUser/:follower/:followee",
                                        params: {
                                            follower: Session.current.name,
                                            followee: userName
                                        },
                                    })
                                    .then(function(result) {
                                        alreadyFollowed = false
                                        var x = document.getElementById("follow_btn").innerHTML = "Follow"
                                    })

                                }



                            },
                        }, followText
                    ),


                    m("hr", ),
                    m(PostGenerator, {
                        postItems: resultPosts.items
                    }),
                ]))


                })

                m.redraw()
            })


        } else {
            alert("no user found")
        }

    })

}

function createHashtagPage(hashtagParam) {
    if (hashtagParam != null && hashtagParam.length > 0) {
        m.request({
                method: "GET",
                url: "http://localhost:8080/_ah/api/myApi/v1/getHashtagPost/:hashtag",
                params: {
                    hashtag: hashtagParam
                },
            })
            .then(function(result) {
                m.mount(document.body, null) // Clean the body
                m.render(document.body, m("div", {
                        class: "hashtagposts-div"
                    },
                    [
                        m("div", m(MenuLogo)),
                        m("h2", "All posts with #" + hashtagParam),
                        m("hr", ),
                        m(PostGenerator, {
                            postItems: result.items
                        }),
                    ]))
                m.redraw()

            })
    }
}

function LikeBtnGenerator() {

    var likeText
    var alreadyLiked
    var postId

    return {

        oninit: function(vnode) {

            postId = vnode.attrs.postIdParam
            likeText = ""
            alreadyLiked = false

            m.request({
                method: "GET",
                url: "http://localhost:8080/_ah/api/myApi/v1/isliked/:postId/:userName",
                params: {
                    postId: postId.id,
                    userName: Session.current.name
                },
            })
            .then(function(resultLiked) {
                console.log(resultLiked)

                if (resultLiked != null) {
                    likeText = "Unlike"
                    alreadyLiked = true
                } else {
                    likeText = "Like"
                    alreadyLiked = false
                }

            })


        }, view: function(vnode) {


             return m( "button", {
                    id: postId.id,
                    class: "like_btn",
                    onclick: function() {
                        if (alreadyLiked == false) {
                            m.request({
                                method: "POST",
                                url: "http://localhost:8080/_ah/api/myApi/v1/like/:postId/:parentId/:userName",
                                params: {
                                    postId: postId.id,
                                    parentId: postId.parent.id,
                                    userName: Session.current.name
                                },
                            })
                            .then(function(result) {
                                console.log(result)
                                alreadyLiked = true
                                var x = document.getElementById(postId.id).innerHTML = "Unlike"
                            })
                        } else {
                            m.request({
                                method: "POST",
                                url: "http://localhost:8080/_ah/api/myApi/v1/unlike/:postId/:userName",
                                params: {
                                    postId: postId.id,
                                    userName: Session.current.name
                                },
                            })
                            .then(function(result) {
                                console.log(result)
                                alreadyLiked = false
                                var x = document.getElementById(postId.id).innerHTML = "Like"
                            })
                        }
                    }
                }, likeText)
        }
    }
}


var MenuLogo = {
    view: function() {
        return m("h1",
            [
                m("a[href='http://localhost:8080/']", "TinyInsta"),
            ],
        )
    }
}

var PostGenerator = {
    view: function(vnode) {

        if(vnode.attrs.postItems == null) {
            return m("div", "No posts found.")
        }

        return m(".post-list", vnode.attrs.postItems.map(function(item) {

            return m(".post-list-item",
                [
                    m(
                        "p",
                        [
                            m(
                                "button", {
                                    class: "user_btn",
                                    onclick: function() {
                                        createUserPage(item.properties.name)
                                    },
                                }, item.properties.name
                            ),


                            m(
                                ".hashtag-list", item.properties.hashtag.map(function(hashtag) {

                                    return m(
                                        "button", {
                                            class: "hashtag-btn",
                                            onclick: function() {
                                                createHashtagPage(hashtag)
                                            },
                                        }, hashtag
                                    )

                                })
                            ),

                            m(LikeBtnGenerator, {postIdParam: item.key}),

                        ],
                        " The " + item.properties.date
                    ),

                    m(
                        "img", {
                            class: "post-img",
                            src: item.properties.image
                        }
                    ),

                    m(
                        "hr",
                    ),
                ])
        }))
    },
}


var PostView = {
    oninit: fetchSession,
    view: function() {
        return m(PostGenerator, {
            postItems: Session.userPost
        })
    },
}




var Main = {
    view: function() {
        return m("main", [

            m("div", m(MenuLogo)),

            m("form", {
                    id: "logoutForm",
                    method: "GET",
                    action: "http://localhost:8080/logout",
                },
                [
                    m("h3", "Connected as " + Session.current.name),
                    m("button.button[type=submit]", "Logout"),
                ]),

            m("form", {
                onsubmit: function(e) {
                    e.preventDefault()
                    createUserPage(SearchForm.values.username)
                }
            }, [
                m("label.label", "name"),
                m("input.input[type=text][placeholder=name]", {
                    oninput: function(e) {
                        SearchForm.values.username = e.target.value
                    },
                }),
                m("button.button[type=submit]", "Search user"),
            ]),

            m("form", {
                    id: "createPostForm",
                    method: "POST",
                    enctype: "multipart/form-data",
                    oncreate: setFormActionUrl
                },
                [
                    // User name is used in the form to send the ajax request, it does not need to be shown
                    m("label.label", {
                        style: {
                            display: "none"
                        }
                    }, "User "),
                    m("input.input[type=text][value=" + Session.current.name + "][name=name]", {
                        style: {
                            display: "none"
                        }
                    }),
                    m("label.label", "Hashtag "),
                    m("input.input[type=text][placeholder='HashtagOne, HashtagB...'][name=hashtag]"),
                    m("input[type=file][name=image]"),
                    m("button.button[type=submit]", "Post"),
                ]),

            m("hr", ),

            m("div", {
                id: "posts"
            }, m(PostView)),


        ])
    }
}

m.mount(document.body, Main)

</script>









</body>



</html>